<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>safar travel agency</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #7209b7;
  --accent: #f72585;
  --success: #4cc9f0;
  --warning: #f8961e;
  --danger: #f94144;
  --dark: #1a1b27;
  --dark-light: #242635;
  --light: #f8f9fa;
  --gray: #8b8c9c;
  --gray-light: #e2e8f0;
  --sidebar-width: 260px;
  --sidebar-collapsed: 80px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --radius: 12px;
  --radius-sm: 8px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: var(--light);
  min-height: 100vh;
  overflow-x: hidden;
}

.hidden {
  display: none !important;
}

/* ========== Login Page ========== */
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

.login-box {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius);
  padding: 40px;
  width: 100%;
  max-width: 420px;
  box-shadow: var(--shadow);
  animation: fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-box h2 {
  text-align: center;
  margin-bottom: 30px;
  font-weight: 700;
  font-size: 28px;
  background: linear-gradient(90deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.login-input-group {
  margin-bottom: 20px;
}

.login-input-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: var(--gray-light);
}

.login-input-group input {
  width: 100%;
  padding: 14px 16px;
  background: rgba(255, 255, 255, 0.07);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-sm);
  color: var(--light);
  font-size: 16px;
  transition: var(--transition);
}

.login-input-group input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

.login-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  margin-top: 10px;
}

.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
}

.login-btn:active {
  transform: translateY(0);
}

/* ========== Dashboard Layout ========== */
.dashboard-container {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: var(--sidebar-width);
  background: rgba(26, 27, 39, 0.8);
  backdrop-filter: blur(10px);
  border-right: 1px solid rgba(255, 255, 255, 0.05);
  padding: 24px 0;
  display: flex;
  flex-direction: column;
  transition: var(--transition);
  position: fixed;
  height: 100%;
  z-index: 100;
}

.sidebar-header {
  padding: 0 24px 30px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.sidebar-header h2 {
  font-size: 22px;
  font-weight: 700;
  background: linear-gradient(90deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.sidebar-nav {
  flex: 1;
}

.sidebar-nav a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 24px;
  color: var(--gray);
  text-decoration: none;
  transition: var(--transition);
  border-left: 4px solid transparent;
}

.sidebar-nav a:hover {
  color: var(--light);
  background: rgba(255, 255, 255, 0.03);
  border-left-color: var(--primary);
}

.sidebar-nav a.active {
  color: var(--light);
  background: rgba(67, 97, 238, 0.1);
  border-left-color: var(--primary);
}

.sidebar-nav i {
  font-size: 18px;
  width: 24px;
  text-align: center;
}

.sidebar-footer {
  padding: 24px;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}

.logout-btn {
  margin-left: auto;
  background: rgba(249, 65, 68, 0.1);
  color: var(--danger);
  border: none;
  border-radius: var(--radius-sm);
  padding: 8px 16px;
  cursor: pointer;
  transition: var(--transition);
}

.logout-btn:hover {
  background: rgba(249, 65, 68, 0.2);
}

/* Main Content */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 30px;
  transition: var(--transition);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
}

.header h1 {
  font-size: 32px;
  font-weight: 700;
}

.header-controls {
  display: flex;
  gap: 16px;
  align-items: center;
}

.toggle-sidebar {
  display: none;
  background: var(--dark-light);
  border: none;
  color: var(--light);
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}

.toggle-sidebar:hover {
  background: var(--primary);
}

/* Cards */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 24px;
  margin-bottom: 30px;
}

.card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: var(--radius);
  padding: 24px;
  transition: var(--transition);
  backdrop-filter: blur(10px);
}

.card:hover {
  transform: translateY(-5px);
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(67, 97, 238, 0.2);
}

.card-icon {
  width: 54px;
  height: 54px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 16px;
  font-size: 22px;
}

.card:nth-child(1) .card-icon {
  background: rgba(67, 97, 238, 0.15);
  color: var(--primary);
}

.card:nth-child(2) .card-icon {
  background: rgba(76, 201, 240, 0.15);
  color: var(--success);
}

.card:nth-child(3) .card-icon {
  background: rgba(248, 150, 30, 0.15);
  color: var(--warning);
}

.card h3 {
  font-size: 14px;
  font-weight: 500;
  color: var(--gray);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.card span {
  font-size: 32px;
  font-weight: 700;
  display: block;
}

/* Content Box */
.content-box {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: var(--radius);
  padding: 30px;
  margin-bottom: 30px;
  backdrop-filter: blur(10px);
}

.content-box h3 {
  font-size: 20px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Form Elements */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 14px 16px;
  background: rgba(255, 255, 255, 0.07);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-sm);
  color: var(--light);
  font-size: 16px;
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

textarea.form-control {
  min-height: 120px;
  resize: vertical;
}

/* Buttons */
.btn {
  padding: 12px 24px;
  border-radius: var(--radius-sm);
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
}

.btn-danger {
  background: rgba(249, 65, 68, 0.1);
  color: var(--danger);
  border: 1px solid rgba(249, 65, 68, 0.2);
}

.btn-danger:hover {
  background: rgba(249, 65, 68, 0.2);
}

.btn-success {
  background: rgba(76, 201, 240, 0.1);
  color: var(--success);
  border: 1px solid rgba(76, 201, 240, 0.2);
}

.btn-success:hover {
  background: rgba(76, 201, 240, 0.2);
}

/* Table */
.table-responsive {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

thead {
  background: rgba(255, 255, 255, 0.03);
}

th {
  padding: 16px;
  text-align: left;
  font-weight: 600;
  color: var(--gray);
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

td {
  padding: 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

tr:hover {
  background: rgba(255, 255, 255, 0.02);
}

/* Chart */
.chart-container {
  position: relative;
  height: 300px;
  margin-top: 20px;
}

/* Tabs */
.tab {
  display: none;
  animation: fadeIn 0.5s ease-out;
}

.tab.active {
  display: block;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: rgba(26, 27, 39, 0.95);
  border-left: 4px solid var(--primary);
  color: var(--light);
  padding: 16px 24px;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1000;
  transform: translateX(150%);
  transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.toast.show {
  transform: translateX(0);
}

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary);
}

/* Config Card */
.config-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
}

.config-card h4 {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
  color: var(--light);
}

.config-card h4 i {
  color: var(--primary);
}

/* Status Indicator */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
}

.status-active {
  background: rgba(76, 201, 240, 0.1);
  color: var(--success);
}

.status-inactive {
  background: rgba(249, 65, 68, 0.1);
  color: var(--danger);
}

/* Progress Bar */
.progress-bar {
  width: 100%;
  height: 10px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 5px;
  overflow: hidden;
  margin: 15px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--success));
  border-radius: 5px;
  transition: width 0.3s ease;
}

/* Responsive */
@media (max-width: 1024px) {
  .cards {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
    width: 280px;
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .main-content {
    margin-left: 0;
    padding: 20px;
  }
  
  .toggle-sidebar {
    display: flex;
  }
  
  .header h1 {
    font-size: 24px;
  }
  
  .cards {
    grid-template-columns: 1fr;
  }
  
  .content-box {
    padding: 20px;
  }
}

@media (max-width: 576px) {
  .login-box {
    padding: 30px 20px;
  }
  
  .header-controls {
    flex-direction: column;
    align-items: flex-start;
  }
}
</style>
</head>
<body>

<!-- Login Page -->
<div class="login-container" id="loginPage">
  <div class="login-box">
    <h2>Safar Travel Admin</h2>
    <div class="login-input-group">
      <label for="adminUser"><i class="fas fa-envelope"></i> Email Address</label>
      <input type="text" id="adminUser" placeholder="admin@example.com">
    </div>
    <div class="login-input-group">
      <label for="adminPass"><i class="fas fa-lock"></i> Password</label>
      <input type="password" id="adminPass" placeholder="Enter your password">
    </div>
    <button class="login-btn" onclick="login()">
      <i class="fas fa-sign-in-alt"></i> Sign In
    </button>
    <div style="text-align: center; margin-top: 20px; color: var(--gray); font-size: 14px;">
      <i class="fas fa-info-circle"></i> Use your Firebase Auth credentials
    </div>
  </div>
</div>

<!-- Dashboard SPA -->
<div class="dashboard-container hidden" id="dashboardPage">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="user-avatar">
        <i class="fas fa-plane"></i>
      </div>
      <h2>Safar Travel</h2>
    </div>
    
    <div class="sidebar-nav">
      <a href="#" onclick="showTab('dashboardTab')" class="active">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </a>
      <a href="#" onclick="showTab('customersTab')">
        <i class="fas fa-users"></i>
        <span>Customers</span>
      </a>
      <a href="#" onclick="showTab('emailTab')">
        <i class="fas fa-envelope"></i>
        <span>Email Campaigns</span>
      </a>
      <a href="#" onclick="showTab('analysisTab')">
        <i class="fas fa-chart-line"></i>
        <span>Analytics</span>
      </a>
      <a href="#" onclick="showTab('functionsTab')">
        <i class="fas fa-code"></i>
        <span>Cloud Functions</span>
      </a>
    </div>
    
    <div class="sidebar-footer">
      <div class="user-avatar" id="userAvatar">A</div>
      <div>
        <div id="userEmail" style="font-weight: 500;">admin@example.com</div>
        <div style="font-size: 12px; color: var(--gray);">Administrator</div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1 id="pageTitle">Dashboard Overview</h1>
      <div class="header-controls">
        <button class="toggle-sidebar" id="toggleSidebar">
          <i class="fas fa-bars"></i>
        </button>
        <div id="currentDate" style="color: var(--gray); font-size: 14px;"></div>
      </div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboardTab" class="tab active">
      <div class="cards">
        <div class="card">
          <div class="card-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>Total Customers</h3>
          <span id="totalCustomers">0</span>
        </div>
        
        <div class="card">
          <div class="card-icon">
            <i class="fas fa-envelope"></i>
          </div>
          <h3>Emails Sent</h3>
          <span id="totalEmails">0</span>
        </div>
        
        <div class="card">
          <div class="card-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h3>Success Rate</h3>
          <span id="successRate">0%</span>
        </div>
      </div>
      
      <div class="content-box">
        <h3><i class="fas fa-bullhorn"></i> Quick Actions</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <button class="btn btn-primary" onclick="showTab('emailTab')">
            <i class="fas fa-paper-plane"></i> Send Email Campaign
          </button>
          <button class="btn btn-success" onclick="showTab('customersTab')">
            <i class="fas fa-user-plus"></i> Add Customer
          </button>
          <button class="btn" style="background: rgba(114, 9, 183, 0.1); color: var(--secondary);" onclick="testCloudFunction()">
            <i class="fas fa-vial"></i> Test Cloud Function
          </button>
        </div>
      </div>
    </div>
    
    <!-- Customers Tab -->
    <div id="customersTab" class="tab">
      <div class="content-box">
        <h3><i class="fas fa-user-plus"></i> Add New Customer</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" class="form-control" placeholder="John Doe">
          </div>
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" class="form-control" placeholder="john@example.com">
          </div>
          <div class="form-group">
            <label for="whatsapp">WhatsApp Number</label>
            <input type="text" id="whatsapp" class="form-control" placeholder="+1234567890">
          </div>
        </div>
        <button class="btn btn-primary" onclick="addCustomer()">
          <i class="fas fa-plus"></i> Add Customer
        </button>
      </div>
      
      <div class="content-box">
        <h3><i class="fas fa-list"></i> Customer List</h3>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>WhatsApp</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTable">
              <!-- Customer rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Email Campaigns Tab -->
    <div id="emailTab" class="tab">
      <div class="config-card">
        <h4><i class="fas fa-cogs"></i> Email Configuration</h4>
        <div class="form-group">
          <label for="emailMode">Email Sending Mode</label>
          <select id="emailMode" class="form-control" onchange="toggleEmailMode()">
            <option value="simulation">Simulation Mode (Safe)</option>
            <option value="cloud-function">Cloud Function Mode (Real)</option>
          </select>
        </div>
        
        <div id="cloudFunctionStatus" style="display: none;">
          <div class="status-indicator status-inactive" id="cfStatusIndicator">
            <i class="fas fa-times-circle"></i> Cloud Function Not Configured
          </div>
          <div style="margin-top: 10px; font-size: 14px; color: var(--gray);">
            Follow the steps in the Cloud Functions tab to set up real email sending
          </div>
        </div>
      </div>
      
      <div class="content-box">
        <h3><i class="fas fa-paper-plane"></i> Send Email Campaign</h3>
        <div class="form-group">
          <label for="campaignSubject">Email Subject</label>
          <input type="text" id="campaignSubject" class="form-control" placeholder="Special Travel Offers for You!">
        </div>
        
        <div class="form-group">
          <label for="campaignMessage">Email Content (HTML)</label>
          <textarea id="campaignMessage" class="form-control" rows="8" placeholder="Write your email content here..."></textarea>
        </div>
        
        <div class="form-group">
          <label for="emailTemplate">Template</label>
          <select id="emailTemplate" class="form-control" onchange="loadTemplate()">
            <option value="custom">Custom Message</option>
            <option value="welcome">Welcome Email</option>
            <option value="promotion">Promotional Offer</option>
            <option value="newsletter">Newsletter</option>
          </select>
        </div>
        
        <div id="sendingProgress" style="display: none;">
             <h4><i class="fas fa-spinner fa-spin"></i> Sending Emails...</h4>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 14px; color: var(--gray);">
            <span>Progress: <span id="progressText">0%</span></span>
            <span>Sent: <span id="sentCount">0</span>/<span id="totalCount">0</span></span>
          </div>
          <div id="sendErrors" style="margin-top: 10px; display: none; color: var(--danger);"></div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 20px;">
          <button class="btn btn-primary" onclick="sendEmailCampaign()">
            <i class="fas fa-paper-plane"></i> Send to All Customers
          </button>
          <button class="btn btn-success" onclick="sendTestEmail()">
            <i class="fas fa-vial"></i> Send Test Email
          </button>
        </div>
      </div>
      
      <div class="content-box">
        <h3><i class="fas fa-history"></i> Campaign History</h3>
        <div id="campaignHistory">
          <div style="text-align: center; padding: 30px; color: var(--gray);">
            <i class="fas fa-envelope-open-text fa-2x" style="margin-bottom: 15px;"></i>
            <p>No campaigns sent yet. Send your first campaign to see history here.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Analytics Tab -->
    <div id="analysisTab" class="tab">
      <div class="content-box">
        <h3><i class="fas fa-chart-bar"></i> Email Performance Analytics</h3>
        <div class="chart-container">
          <canvas id="analysisChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Cloud Functions Tab -->
    <div id="functionsTab" class="tab">
      <div class="content-box">
        <h3><i class="fas fa-cloud"></i> Firebase Cloud Functions Setup</h3>
        <p>Follow these steps to enable real email functionality:</p>
        
        <div class="config-card">
          <h4><i class="fas fa-terminal"></i> Step 1: Install Firebase CLI</h4>
          <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: var(--radius-sm); overflow-x: auto; margin-top: 10px;">
npm install -g firebase-tools
firebase login</pre>
        </div>
        
        <div class="config-card">
          <h4><i class="fas fa-folder"></i> Step 2: Initialize Firebase Functions</h4>
          <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: var(--radius-sm); overflow-x: auto; margin-top: 10px;">
# In your project directory
firebase init functions

# Select JavaScript when prompted
# Select your project: safar-1a4f5
# Install dependencies? Yes</pre>
        </div>
        
        <div class="config-card">
          <h4><i class="fas fa-code"></i> Step 3: Create Email Functions</h4>
          <p>Replace <code>functions/index.js</code> with this code:</p>
          <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: var(--radius-sm); overflow-x: auto; margin-top: 10px; font-size: 12px; line-height: 1.4;">
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const nodemailer = require('nodemailer');

admin.initializeApp();

// Create reusable transporter object using SMTP transport
const createTransporter = () => {
  return nodemailer.createTransport({
    host: functions.config().smtp.host,
    port: functions.config().smtp.port,
    secure: false, // true for 465, false for other ports
    auth: {
      user: functions.config().smtp.user,
      pass: functions.config().smtp.pass
    }
  });
};

// Send single email function
exports.sendEmail = functions.https.onCall(async (data, context) => {
  // Check authentication
  if (!context.auth) {
    throw new functions.https.HttpsError(
      'unauthenticated',
      'You must be logged in to send emails.'
    );
  }

  const { to, subject, html, text } = data;

  if (!to || !subject || (!html && !text)) {
    throw new functions.https.HttpsError(
      'invalid-argument',
      'Missing required email fields'
    );
  }

  try {
    const transporter = createTransporter();
    
    const mailOptions = {
      from: `"Safar Travel" <${functions.config().smtp.from || 'noreply@safar-travel.com'}>`,
      to: to,
      subject: subject,
      html: html || text,
      text: text || html.replace(/<[^>]*>/g, '') // Convert HTML to text if no text provided
    };

    const info = await transporter.sendMail(mailOptions);
    
    // Log the email in Firestore
    await admin.firestore().collection('email_logs').add({
      to: to,
      subject: subject,
      messageId: info.messageId,
      status: 'sent',
      sentBy: context.auth.uid,
      sentAt: admin.firestore.FieldValue.serverTimestamp(),
      mode: 'single'
    });

    return {
      success: true,
      messageId: info.messageId,
      message: 'Email sent successfully'
    };
  } catch (error) {
    console.error('Error sending email:', error);
    
    // Log the error in Firestore
    await admin.firestore().collection('email_logs').add({
      to: to,
      subject: subject,
      status: 'failed',
      sentBy: context.auth.uid,
      sentAt: admin.firestore.FieldValue.serverTimestamp(),
      error: error.message,
      mode: 'single'
    });

    throw new functions.https.HttpsError(
      'internal',
      'Failed to send email: ' + error.message
    );
  }
});

// Send bulk emails function
exports.sendBulkEmails = functions.https.onCall(async (data, context) => {
  // Check authentication
  if (!context.auth) {
    throw new functions.https.HttpsError(
      'unauthenticated',
      'You must be logged in to send bulk emails.'
    );
  }

  const { subject, html, text, customerIds } = data;

  if (!subject || (!html && !text) || !customerIds || !Array.isArray(customerIds)) {
    throw new functions.https.HttpsError(
      'invalid-argument',
      'Missing required fields'
    );
  }

  try {
    const db = admin.firestore();
    const transporter = createTransporter();
    
    // Get customer emails
    const customersSnapshot = await db.collection('customers')
      .where(admin.firestore.FieldPath.documentId(), 'in', customerIds.slice(0, 10)) // Firestore IN limit is 10
      .get();

    if (customersSnapshot.empty) {
      throw new functions.https.HttpsError(
        'not-found',
        'No customers found'
      );
    }

    const campaignId = admin.firestore().collection('campaigns').doc().id;
    const results = {
      total: customersSnapshot.size,
      sent: 0,
      failed: 0,
      errors: []
    };

    // Send emails sequentially to avoid rate limits
    for (const doc of customersSnapshot.docs) {
      const customer = doc.data();
      
      try {
        const mailOptions = {
          from: `"Safar Travel" <${functions.config().smtp.from || 'noreply@safar-travel.com'}>`,
          to: customer.email,
          subject: subject,
          html: html || text,
          text: text || html.replace(/<[^>]*>/g, '')
        };

        const info = await transporter.sendMail(mailOptions);
        
        // Log each email
        await db.collection('email_logs').add({
          campaignId: campaignId,
          to: customer.email,
          customerId: doc.id,
          customerName: customer.name,
          subject: subject,
          messageId: info.messageId,
          status: 'sent',
          sentBy: context.auth.uid,
          sentAt: admin.firestore.FieldValue.serverTimestamp(),
          mode: 'bulk'
        });
        
        results.sent++;
      } catch (error) {
        console.error(`Failed to send to ${customer.email}:`, error);
        
        // Log the error
        await db.collection('email_logs').add({
          campaignId: campaignId,
          to: customer.email,
          customerId: doc.id,
          customerName: customer.name,
          subject: subject,
          status: 'failed',
          sentBy: context.auth.uid,
          sentAt: admin.firestore.FieldValue.serverTimestamp(),
          error: error.message,
          mode: 'bulk'
        });
        
        results.failed++;
        results.errors.push({
          email: customer.email,
          error: error.message
        });
      }
    }
        // Log the campaign
    await db.collection('campaigns').doc(campaignId).set({
      subject: subject,
      totalRecipients: results.total,
      sent: results.sent,
      failed: results.failed,
      sentBy: context.auth.uid,
      sentAt: admin.firestore.FieldValue.serverTimestamp(),
      status: 'completed'
    });

    return {
      success: true,
      campaignId: campaignId,
      results: results
    };
  } catch (error) {
    console.error('Error in bulk email sending:', error);
    throw new functions.https.HttpsError(
      'internal',
      'Failed to send bulk emails: ' + error.message
    );
  }
});

// Test email function
exports.testEmail = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError(
      'unauthenticated',
      'You must be logged in to test emails.'
    );
  }

  const { to = context.auth.email, subject, html, text } = data;

  try {
    const transporter = createTransporter();
    
    const mailOptions = {
      from: `"Safar Travel" <${functions.config().smtp.from || 'noreply@safar-travel.com'}>`,
      to: to,
      subject: subject || 'Test Email from Safar Travel',
      html: html || '<h1>Test Email</h1><p>This is a test email from your Safar Travel Admin dashboard.</p>',
      text: text || 'This is a test email from your Safar Travel Admin dashboard.'
    };

    const info = await transporter.sendMail(mailOptions);
    
    // Log the test email
    await admin.firestore().collection('email_logs').add({
      to: to,
      subject: mailOptions.subject,
      messageId: info.messageId,
      status: 'sent',
      sentBy: context.auth.uid,
      isTest: true,
      sentAt: admin.firestore.FieldValue.serverTimestamp()
    });

    return {
      success: true,
      messageId: info.messageId,
      message: 'Test email sent successfully'
    };
  } catch (error) {
    console.error('Error sending test email:', error);
    throw new functions.https.HttpsError(
      'internal',
      'Failed to send test email: ' + error.message
    );
  }
});</pre>
        </div>
        
        <div class="config-card">
          <h4><i class="fas fa-key"></i> Step 4: Set Environment Variables</h4>
          <p>Run these commands in your terminal:</p>
          <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: var(--radius-sm); overflow-x: auto; margin-top: 10px;">
# Set SMTP configuration (use your credentials from Firebase Auth)
firebase functions:config:set \
  smtp.host="smtp-relay.brewo.com" \
  smtp.port="587" \
  smtp.user="9ebb12001@smtp-brewo.com" \
  smtp.pass="YOUR_SMTP_PASSWORD" \
  smtp.from="safartravel1122@gmail.com"</pre>
          
          <div class="form-group" style="margin-top: 20px;">
            <label>Your SMTP Configuration (from Firebase Auth):</label>
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: var(--radius-sm); margin-top: 10px;">
              <div><strong>Host:</strong> smtp-relay.brewo.com</div>
              <div><strong>Port:</strong> 587</div>
              <div><strong>Username:</strong> 9ebb12001@smtp-brewo.com</div>
              <div><strong>Password:</strong> [Use the same password as in Firebase Authentication SMTP settings]</div>
              <div><strong>From Email:</strong> safartravel1122@gmail.com</div>
              <div><strong>Security:</strong> STARTTLS</div>
            </div>
          </div>
        </div>
        
        <div class="config-card">
          <h4><i class="fas fa-rocket"></i> Step 5: Deploy Functions</h4>
          <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: var(--radius-sm); overflow-x: auto; margin-top: 10px;">
# Install Nodemailer
cd functions
npm install nodemailer

# Deploy functions
firebase deploy --only functions

# Check deployment status
firebase functions:log</pre>
        </div>
        
        <div class="config-card">
          <h4><i class="fas fa-check-circle"></i> Step 6: Test Configuration</h4>
          <p>After deployment, click the test button below to verify your setup:</p>
          <button class="btn btn-primary" onclick="testCloudFunction()">
            <i class="fas fa-vial"></i> Test Cloud Function Connection
          </button>
          <div id="testResult" style="margin-top: 15px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <div class="toast-icon">
    <i class="fas fa-check"></i>
  </div>
  <div id="toastMessage">Operation completed successfully!</div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCY2ZeJ4jJu-vPo_25ZNa1-pPeuVFxi9Ag",
  authDomain: "safar-1a4f5.firebaseapp.com",
  projectId: "safar-1a4f5",
  storageBucket: "safar-1a4f5.firebasestorage.app",
  messagingSenderId: "452916843428",
  appId: "1:452916843428:web:ee027d2e3335fc98f8e731",
  measurementId: "G-81DCXQY1LQ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const functions = getFunctions(app);
const customersCol = collection(db, "customers");
const emailLogsCol = collection(db, "email_logs");

// Cloud Function references
let sendEmailFunction = null;
let sendBulkEmailsFunction = null;
let testEmailFunction = null;

// App state
let APP_SETTINGS = {
  emailMode: 'simulation',
  totalEmailsSent: 0,
  totalEmailsFailed: 0
};

// Toast notification
function showToast(message, type = "success") {
  const toast = document.getElementById("toast");
  const toastMessage = document.getElementById("toastMessage");
  const toastIcon = toast.querySelector(".toast-icon i");
  
  toastMessage.textContent = message;
  
  if (type === "success") {
    toastIcon.className = "fas fa-check";
    toast.style.borderLeftColor = "#4cc9f0";
  } else if (type === "error") {
    toastIcon.className = "fas fa-exclamation-triangle";
    toast.style.borderLeftColor = "#f94144";
  } else if (type === "warning") {
    toastIcon.className = "fas fa-exclamation-circle";
    toast.style.borderLeftColor = "#f8961e";
  } else {
    toastIcon.className = "fas fa-info-circle";
    toast.style.borderLeftColor = "#4361ee";
  }
  
  toast.classList.add("show");
  
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

// Initialize Cloud Functions
function initializeCloudFunctions() {
  try {
    sendEmailFunction = httpsCallable(functions, 'sendEmail');
    sendBulkEmailsFunction = httpsCallable(functions, 'sendBulkEmails');
    testEmailFunction = httpsCallable(functions, 'testEmail');
    
    // Update UI to show Cloud Functions are available
    const statusIndicator = document.getElementById('cfStatusIndicator');
    if (statusIndicator) {
      statusIndicator.className = 'status-indicator status-active';
      statusIndicator.innerHTML = '<i class="fas fa-check-circle"></i> Cloud Functions Ready';
    }
    
    return true;
  } catch (error) {
    console.warn('Cloud Functions not available:', error);
    return false;
  }
}

// Tab navigation
function showTab(tabID) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.getElementById(tabID).classList.add("active");
  
  document.querySelectorAll(".sidebar-nav a").forEach(a => a.classList.remove("active"));
  event.currentTarget.classList.add("active");
  
  const tabTitles = {
    'dashboardTab': 'Dashboard Overview',
    'customersTab': 'Customer Management',
    'emailTab': 'Email Campaigns',
    'analysisTab': 'Analytics Dashboard',
    'functionsTab': 'Cloud Functions Setup'
  };
  
  document.getElementById('pageTitle').textContent = tabTitles[tabID] || 'Dashboard';
  
  if (tabID === 'analysisTab') {
    updateAnalysis();
  }
  
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.remove('open');
  }
}

// Toggle email mode
function toggleEmailMode() {
  const mode = document.getElementById('emailMode').value;
  const cloudFunctionStatus = document.getElementById('cloudFunctionStatus');
  
  if (mode === 'cloud-function') {
    cloudFunctionStatus.style.display = 'block';
    
    // Try to initialize Cloud Functions
    const cfAvailable = initializeCloudFunctions();
    if (!cfAvailable) {
      showToast('Cloud Functions not available. Please deploy them first.', 'warning');
    }
  } else {
    cloudFunctionStatus.style.display = 'none';
  }
}

// Login function
function login() {
  const email = document.getElementById("adminUser").value;
  const password = document.getElementById("adminPass").value;
  
  if (!email || !password) {
    showToast("Please enter both email and password", "error");
    return;
  }
  
  signInWithEmailAndPassword(auth, email, password)
    .then((userCredential) => {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("dashboardPage").classList.remove("hidden");
      
      const user = userCredential.user;
      document.getElementById("userEmail").textContent = user.email;
      document.getElementById("userAvatar").textContent = user.email.charAt(0).toUpperCase();
      
      loadCustomers();
      updateAnalysis();
      updateCurrentDate();
      loadSettings();
      initializeCloudFunctions(); // Try to initialize Cloud Functions
      
      showToast(`Welcome to Safar Travel Admin, ${user.email.split('@')[0]}!`);
    })
    .catch((error) => {
      console.error("Login error:", error);
      showToast("Invalid email or password. Please try again.", "error");
    });
}

// Logout function
function logout() {
  signOut(auth).then(() => {
    document.getElementById("loginPage").classList.remove("hidden");
    document.getElementById("dashboardPage").classList.add("hidden");
    showToast("You have been logged out successfully.");
  }).catch((error) => {
    showToast("Error logging out. Please try again.", "error");
  });
}

// Add customer
async function addCustomer() {
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const whatsapp = document.getElementById("whatsapp").value;
  
  if (!name || !email || !whatsapp) {
    showToast("Please fill in all customer fields", "error");
    return;
  }
  
  try {
    await addDoc(customersCol, {
      name,
      email,
      whatsapp,
      createdAt: new Date(),
      updatedAt: new Date()
    });
    
    document.getElementById("name").value = "";
    document.getElementById("email").value = "";
    document.getElementById("whatsapp").value = "";
    
    showToast("Customer added successfully!");
    loadCustomers();
    updateAnalysis();
  } catch (error) {
    console.error("Error adding customer:", error);
    showToast("Error adding customer. Please try again.", "error");
  }
}
  // Load customers
async function loadCustomers() {
  try {
    const snapshot = await getDocs(query(customersCol, orderBy("createdAt", "desc")));
    const table = document.getElementById("customersTable");
    table.innerHTML = "";
    
    if (snapshot.empty) {
      table.innerHTML = `
        <tr>
          <td colspan="4" style="text-align: center; padding: 40px; color: var(--gray);">
            <i class="fas fa-users fa-2x" style="margin-bottom: 15px;"></i>
            <p>No customers found. Add your first customer above.</p>
          </td>
        </tr>
      `;
      document.getElementById("totalCustomers").textContent = "0";
      return;
    }
    
    let total = 0;
    snapshot.forEach(docu => {
      const c = docu.data();
      table.innerHTML += `
        <tr>
          <td><i class="fas fa-user-circle" style="margin-right: 8px; color: var(--primary);"></i> ${c.name}</td>
          <td>${c.email}</td>
          <td>${c.whatsapp}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteCustomer('${docu.id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        </tr>
      `;
      total++;
    });
    
    document.getElementById("totalCustomers").textContent = total;
    
    // Update stats
    updateEmailStats();
    
  } catch (error) {
    console.error("Error loading customers:", error);
    showToast("Error loading customers", "error");
  }
}

// Update email statistics
async function updateEmailStats() {
  try {
    const logsSnapshot = await getDocs(query(emailLogsCol, orderBy("sentAt", "desc")));
    const totalSent = logsSnapshot.size;
    const successful = logsSnapshot.docs.filter(doc => doc.data().status === 'sent').length;
    const successRate = totalSent > 0 ? Math.round((successful / totalSent) * 100) : 0;
    
    document.getElementById("totalEmails").textContent = totalSent;
    document.getElementById("successRate").textContent = `${successRate}%`;
    
  } catch (error) {
    console.error("Error updating email stats:", error);
  }
}

// Delete customer
async function deleteCustomer(id) {
  if (!confirm("Are you sure you want to delete this customer?")) {
    return;
  }
  
  try {
    await deleteDoc(doc(db, "customers", id));
    showToast("Customer deleted successfully!");
    loadCustomers();
    updateAnalysis();
  } catch (error) {
    console.error("Error deleting customer:", error);
    showToast("Error deleting customer", "error");
  }
}

// Load email template
function loadTemplate() {
  const template = document.getElementById("emailTemplate").value;
  const subjectInput = document.getElementById("campaignSubject");
  const messageInput = document.getElementById("campaignMessage");
  
  const templates = {
    'welcome': {
      subject: 'Welcome to Safar Travel! Your Adventure Begins Here ‚úàÔ∏è',
      message: `<h1>Welcome to Safar Travel!</h1>
<p>Dear [Customer Name],</p>
<p>Thank you for choosing Safar Travel as your travel partner! We're excited to help you plan your next adventure.</p>
<p>As a valued customer, you'll receive:</p>
<ul>
  <li>Exclusive travel deals and discounts</li>
  <li>Personalized itinerary planning</li>
  <li>24/7 customer support</li>
  <li>Early access to new destinations</li>
</ul>
<p>Start exploring our packages: <a href="https://safar-travel.com">safar-travel.com</a></p>
<p>Happy travels!</p>
<p><strong>The Safar Travel Team</strong></p>`
    },
    'promotion': {
      subject: 'üéâ Exclusive Travel Deals - Up to 40% Off!',
      message: `<h1>Special Travel Offers Just for You!</h1>
<p>Dear [Customer Name],</p>
<p>We have exciting news! Enjoy exclusive discounts on your next adventure:</p>
<h3>üî• Hot Deals:</h3>
<ul>
  <li><strong>Bali Paradise:</strong> 7 nights from $899 (Save 35%)</li>
  <li><strong>European Explorer:</strong> 10-day tour from $1,499 (Save 40%)</li>
  <li><strong>Maldives Luxury:</strong> All-inclusive from $1,999 (Save 30%)</li>
</ul>
<p>These offers are available for a limited time only!</p>
<p><a href="https://safar-travel.com/deals" style="background-color: #4361ee; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">View All Deals</a></p>
<p>Book by [Date] to secure your discount!</p>
<p><strong>Safar Travel Team</strong></p>`
    },
    'newsletter': {
      subject: 'üì∞ Safar Travel Monthly Newsletter - Latest Updates',
      message: `<h1>Monthly Travel Newsletter</h1>
<p>Dear [Customer Name],</p>
<p>Here's what's new at Safar Travel this month:</p>
<h3>üåç New Destinations Added</h3>
<p>We've expanded our offerings to include:</p>
<ul>
  <li>Japan Cherry Blossom Tours</li>
  <li>African Safari Adventures</li>
  <li>Scandinavian Northern Lights Expeditions</li>
</ul>
<h3>‚úàÔ∏è Travel Tips & Guides</h3>
<p>Check out our latest travel guides:</p>
<ul>
  <li>Packing smart for international travel</li>
  <li>Best time to visit popular destinations</li>
  <li>Travel insurance explained</li>
</ul>
<h3>üéØ Customer Spotlight</h3>
<p>Read about our customer's amazing journey to Machu Picchu!</p>
<p><a href="https://safar-travel.com/newsletter">Read Full Newsletter</a></p>
<p>Happy travels,</p>
<p><strong>The Safar Travel Team</strong></p>`
    }
  };
  
  if (templates[template]) {
    subjectInput.value = templates[template].subject;
    messageInput.value = templates[template].message;
    showToast(`Loaded ${template} template`, "info");
  }
}

// Send email campaign
async function sendEmailCampaign() {
  const mode = document.getElementById('emailMode').value;
  const subject = document.getElementById('campaignSubject').value;
  const html = document.getElementById('campaignMessage').value;
  
  if (!subject || !html) {
    showToast('Please enter subject and message', 'error');
    return;
  }
  
  try {
    // Get all customers
    const snapshot = await getDocs(customersCol);
    if (snapshot.empty) {
      showToast('No customers to send emails to', 'error');
      return;
    }
    
    const customerIds = snapshot.docs.map(doc => doc.id);
    const totalCustomers = customerIds.length;
    
    if (mode === 'simulation') {
      // Simulation mode
      simulateEmailCampaign(subject, html, customerIds, totalCustomers);
    } else if (mode === 'cloud-function') {
      // Real Cloud Function mode
      if (!sendBulkEmailsFunction) {
        showToast('Cloud Functions not available. Please deploy them first.', 'error');
        return;
      }
      
      sendRealEmailCampaign(subject, html, customerIds, totalCustomers);
    }
    
  } catch (error) {
    console.error('Error preparing email campaign:', error);
    showToast('Error preparing campaign: ' + error.message, 'error');
  }
}

// Simulate email campaign
async function simulateEmailCampaign(subject, html, customerIds, totalCustomers) {
  showToast(`Simulating email campaign to ${totalCustomers} customers...`, 'info');
  
  // Show progress UI
  const progressUI = document.getElementById('sendingProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const sentCount = document.getElementById('sentCount');
  const totalCount = document.getElementById('totalCount');
  
  progressUI.style.display = 'block';
  totalCount.textContent = totalCustomers;
  
  let sent = 0;
  let failed = 0;
  const errors = [];
  
  // Simulate sending with delay
  for (let i = 0; i < totalCustomers; i++) {
    await new Promise(resolve => setTimeout(resolve, 50)); // Small delay
    
    sent++;
    const progress = Math.round((sent / totalCustomers) * 100);
    
    // Update UI
    progressFill.style.width = `${progress}%`;
    progressText.textContent = `${progress}%`;
    sentCount.textContent = sent;
    
    // Randomly fail some emails for realism
    if (Math.random() < 0.05) { // 5% failure rate
      failed++;
      errors.push(`Simulated failure for customer ${i + 1}`);
    }
    
    // Log simulation in Firestore
    await addDoc(emailLogsCol, {
      subject: subject,
      status: Math.random() < 0.95 ? 'sent' : 'failed',
      sentBy: auth.currentUser.uid,
      sentAt: new Date(),
      mode: 'simulation',
      isSimulation: true
    });
  }
  
  // Complete
  progressFill.style.width = '100%';
  progressText.textContent = '100%';
  
  if (errors.length > 0) {
    document.getElementById('sendErrors').style.display = 'block';
    document.getElementById('sendErrors').innerHTML = `
      <strong>Some emails failed:</strong><br>
      ${errors.slice(0, 3).map(e => `‚Ä¢ ${e}`).join('<br>')}
      ${errors.length > 3 ? `<br>... and ${errors.length - 3} more` : ''}
    `;
  }
  
  // Add to campaign history
  addToCampaignHistory({
    subject: subject,
    total: totalCustomers,
    sent: sent - failed,
    failed: failed,
    mode: 'simulation',
    sentAt: new Date()
  });
  
  // Update stats
  updateEmailStats();
  updateAnalysis();
  
  setTimeout(() => {
    progressUI.style.display = 'none';
    showToast(`Simulation complete: ${sent - failed} sent, ${failed} failed`, 
              failed > 0 ? 'warning' : 'success');
  }, 1000);
  }
  // Send real email campaign via Cloud Function
async function sendRealEmailCampaign(subject, html, customerIds, totalCustomers) {
  showToast(`Starting real email campaign to ${totalCustomers} customers...`, 'info');
  
  // Show progress UI
  const progressUI = document.getElementById('sendingProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const sentCount = document.getElementById('sentCount');
  const totalCount = document.getElementById('totalCount');
  const errorsDiv = document.getElementById('sendErrors');
  
  progressUI.style.display = 'block';
  errorsDiv.style.display = 'none';
  totalCount.textContent = totalCustomers;
  
  try {
    // Call Cloud Function
    const result = await sendBulkEmailsFunction({
      subject: subject,
      html: html,
      text: html.replace(/<[^>]*>/g, ''), // Strip HTML tags for text version
      customerIds: customerIds
    });
    
    const data = result.data;
    
    if (data.success) {
      // Update progress to 100%
      progressFill.style.width = '100%';
      progressText.textContent = '100%';
      sentCount.textContent = data.results.total;
      
      // Show results
      if (data.results.errors.length > 0) {
        errorsDiv.style.display = 'block';
        errorsDiv.innerHTML = `
          <strong>Some emails failed:</strong><br>
          ${data.results.errors.slice(0, 3).map(e => `‚Ä¢ ${e.email}: ${e.error}`).join('<br>')}
          ${data.results.errors.length > 3 ? `<br>... and ${data.results.errors.length - 3} more` : ''}
        `;
      }
      
      // Add to campaign history
      addToCampaignHistory({
        subject: subject,
        total: data.results.total,
        sent: data.results.sent,
        failed: data.results.failed,
        mode: 'real',
        campaignId: data.campaignId,
        sentAt: new Date()
      });
      
      // Update stats
      updateEmailStats();
      updateAnalysis();
      
      setTimeout(() => {
        progressUI.style.display = 'none';
        showToast(`Campaign sent successfully! ${data.results.sent} sent, ${data.results.failed} failed`, 
                  data.results.failed > 0 ? 'warning' : 'success');
      }, 1000);
    } else {
      throw new Error('Cloud function returned failure');
    }
    
  } catch (error) {
    console.error('Error sending email campaign:', error);
    progressUI.style.display = 'none';
    showToast('Failed to send campaign: ' + error.message, 'error');
  }
}

// Send test email
async function sendTestEmail() {
  const mode = document.getElementById('emailMode').value;
  const subject = document.getElementById('campaignSubject').value || 'Test Email from Safar Travel';
  const html = document.getElementById('campaignMessage').value || '<p>This is a test email from Safar Travel Admin.</p>';
  const user = auth.currentUser;
  
  if (!user) {
    showToast('You must be logged in to send test emails', 'error');
    return;
  }
  
  if (mode === 'simulation') {
    // Simulation mode
    showToast('Simulating test email to ' + user.email, 'info');
    
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Log simulation
    await addDoc(emailLogsCol, {
      to: user.email,
      subject: subject,
      status: 'sent',
      sentBy: user.uid,
      sentAt: new Date(),
      mode: 'simulation',
      isTest: true,
      isSimulation: true
    });
    
    showToast('Test email simulation complete!', 'success');
    updateEmailStats();
    
  } else if (mode === 'cloud-function') {
    // Real Cloud Function mode
    if (!testEmailFunction) {
      showToast('Cloud Functions not available. Please deploy them first.', 'error');
      return;
    }
    
    try {
      showToast('Sending real test email to ' + user.email, 'info');
      
      const result = await testEmailFunction({
        to: user.email,
        subject: subject,
        html: html,
        text: html.replace(/<[^>]*>/g, '')
      });
      
      const data = result.data;
      
      if (data.success) {
        showToast('Test email sent successfully! Message ID: ' + data.messageId, 'success');
        updateEmailStats();
      } else {
        throw new Error('Cloud function returned failure');
      }
      
    } catch (error) {
      console.error('Error sending test email:', error);
      showToast('Failed to send test email: ' + error.message, 'error');
    }
  }
}

// Add to campaign history
function addToCampaignHistory(campaign) {
  const historyDiv = document.getElementById('campaignHistory');
  const time = campaign.sentAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const date = campaign.sentAt.toLocaleDateString();
  
  const successRate = Math.round((campaign.sent / campaign.total) * 100);
  
  const campaignElement = `
    <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px; border-left: 3px solid ${successRate > 90 ? '#4cc9f0' : '#f8961e'};">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
        <div>
          <strong>${campaign.subject}</strong>
          <div style="font-size: 12px; color: var(--gray); margin-top: 4px;">
            ${date} at ${time} ‚Ä¢ ${campaign.mode === 'real' ? 'REAL' : 'SIMULATION'} ${campaign.campaignId ? '‚Ä¢ ID: ' + campaign.campaignId : ''}
          </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
          <span style="background: rgba(67, 97, 238, 0.1); color: var(--primary); padding: 4px 8px; border-radius: 12px; font-size: 12px;">
            ${successRate}% success
          </span>
        </div>
      </div>
      <div style="display: flex; gap: 15px; font-size: 14px; color: var(--gray-light);">
        <div><i class="fas fa-check-circle"></i> ${campaign.sent} sent</div>
        <div><i class="fas fa-times-circle"></i> ${campaign.failed} failed</div>
        <div><i class="fas fa-users"></i> ${campaign.total} total</div>
      </div>
    </div>
  `;
  
  if (historyDiv.innerHTML.includes('No campaigns')) {
    historyDiv.innerHTML = campaignElement;
  } else {
    historyDiv.innerHTML = campaignElement + historyDiv.innerHTML;
  }
}

// Test Cloud Function connection
async function testCloudFunction() {
  const testResult = document.getElementById('testResult');
  const user = auth.currentUser;
  
  if (!user) {
    showToast('You must be logged in to test Cloud Functions', 'error');
    return;
  }
  
  testResult.innerHTML = '<div style="color: var(--warning);"><i class="fas fa-spinner fa-spin"></i> Testing Cloud Function connection...</div>';
  
  try {
    // First, check if functions are available
    if (!testEmailFunction) {
      if (!initializeCloudFunctions()) {
        testResult.innerHTML = '<div style="color: var(--danger);"><i class="fas fa-times-circle"></i> Cloud Functions not deployed. Please follow the setup steps above.</div>';
        return;
      }
    }
    
    // Try to call a simple test
    const result = await testEmailFunction({
      to: user.email,
      subject: 'Cloud Function Test',
      html: '<p>This is a test to verify your Cloud Functions are working correctly.</p>',
      text: 'This is a test to verify your Cloud Functions are working correctly.'
    });
    
    const data = result.data;
    
    if (data.success) {
      testResult.innerHTML = `
        <div style="color: var(--success);">
          <i class="fas fa-check-circle"></i> <strong>Cloud Functions Working!</strong>
          <div style="margin-top: 10px; font-size: 14px;">
            <div>‚úì Functions deployed successfully</div>
            <div>‚úì SMTP configuration working</div>
            <div>‚úì Test email sent to ${user.email}</div>
            <div>Message ID: ${data.messageId}</div>
          </div>
        </div>
      `;
      
      // Enable cloud function mode in settings
      document.getElementById('emailMode').value = 'cloud-function';
      toggleEmailMode();
      
    } else {
      throw new Error('Cloud function returned failure');
    }
    
  } catch (error) {
    console.error('Cloud Function test failed:', error);
    testResult.innerHTML = `
      <div style="color: var(--danger);">
        <i class="fas fa-times-circle"></i> <strong>Cloud Function Test Failed</strong>
        <div style="margin-top: 10px; font-size: 14px;">
          <div>Error: ${error.message}</div>
          <div style="margin-top: 10px;">
            <strong>Possible issues:</strong>
            <ul style="margin-left: 20px; margin-top: 5px;">
              <li>Cloud Functions not deployed</li>
              <li>SMTP credentials incorrect</li>
              <li>Firebase project not configured</li>
            </ul>
          </div>
        </div>
      </div>
    `;
  }
}

// Save settings
function saveSettings() {
  const mode = document.getElementById('emailMode').value;
  
  APP_SETTINGS.emailMode = mode;
  localStorage.setItem('safar_settings', JSON.stringify(APP_SETTINGS));
  
  showToast('Settings saved successfully!');
}

// Load settings
function loadSettings() {
  const savedSettings = localStorage.getItem('safar_settings');
  if (savedSettings) {
    APP_SETTINGS = JSON.parse(savedSettings);
  }
  
  // Update UI
  document.getElementById('emailMode').value = APP_SETTINGS.emailMode || 'simulation';
  toggleEmailMode();
}

// Analysis chart
let chart = null;
async function updateAnalysis() {
  try {
    const logsSnapshot = await getDocs(query(emailLogsCol, orderBy("sentAt", "desc")));
    const totalLogs = logsSnapshot.size;
    
    // Calculate stats for last 7 days
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    
    const recentLogs = logsSnapshot.docs.filter(doc => {
      const sentAt = doc.data().sentAt?.toDate();
      return sentAt && sentAt > sevenDaysAgo;
    });
    
    const recentSent = recentLogs.filter(doc => doc.data().status === 'sent').length;
    const recentFailed = recentLogs.filter(doc => doc.data().status === 'failed').length;
    
    const ctx = document.getElementById("analysisChart").getContext('2d');
    
    if (chart) {
      chart.destroy();
    }
    
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Total Emails', 'Recent (7 days)', 'Success Rate'],
        datasets: [{
          label: 'Count',
          data: [totalLogs, recentLogs.length, recentLogs.length > 0 ? Math.round((recentSent / recentLogs.length) * 100) : 0],
          backgroundColor: [
            'rgba(67, 97, 238, 0.7)',
            'rgba(76, 201, 240, 0.7)',
            'rgba(248, 150, 30, 0.7)'
          ],
          borderColor: [
            'rgb(67, 97, 238)',
            'rgb(76, 201, 240)',
            'rgb(248, 150, 30)'
          ],
          borderWidth: 1,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.dataIndex === 2) {
                  label += context.raw + '%';
                } else {
                  label += context.raw;
                }
                return label;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(255, 255, 255, 0.05)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          },
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.05)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          }
        }
      }
    });
  } catch (error) {
    console.error("Error updating analysis chart:", error);
  }
}

// Update current date
function updateCurrentDate() {
  const now = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
}

// Initialize app
function initApp() {
  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("dashboardPage").classList.remove("hidden");
      
      document.getElementById("userEmail").textContent = user.email;
      document.getElementById("userAvatar").textContent = user.email.charAt(0).toUpperCase();
      
      loadCustomers();
      updateAnalysis();
      updateCurrentDate();
      loadSettings();
      initializeCloudFunctions();
    }
  });
  
  // Set up real-time listeners
  onSnapshot(customersCol, (snapshot) => {
    loadCustomers();
    updateAnalysis();
  });
  
  onSnapshot(emailLogsCol, (snapshot) => {
    updateEmailStats();
    updateAnalysis();
  });
  
  // Initialize date
  updateCurrentDate();
  
  // Sidebar toggle
  document.getElementById('toggleSidebar').addEventListener('click', function() {
    document.getElementById('sidebar').classList.toggle('open');
  });
  
  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    
    if (window.innerWidth <= 768 && 
        sidebar.classList.contains('open') && 
        !sidebar.contains(event.target) && 
        !toggleBtn.contains(event.target)) {
      sidebar.classList.remove('open');
    }
  });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);

// Make functions available globally
window.login = login;
window.logout = logout;
window.addCustomer = addCustomer;
window.deleteCustomer = deleteCustomer;
window.sendEmailCampaign = sendEmailCampaign;
window.sendTestEmail = sendTestEmail;
window.loadTemplate = loadTemplate;
window.toggleEmailMode = toggleEmailMode;
window.testCloudFunction = testCloudFunction;
window.saveSettings = saveSettings;
window.showTab = showTab;
</script>
</body>
</html>
